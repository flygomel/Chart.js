export default class Chart{constructor(t,i){return this.el="string"==typeof t?this.q(t):t,this.options={classPrefix:"chart",mode:"night",...i},this.padding=[{vertical:46,horizontal:24,bottom:20},{vertical:8,horizontal:0,bottom:0}],this.setMode(this.options.mode),this.addStyle(),this}addStyle(){let t=document.createElement("style");t.innerHTML=style(this.options.classPrefix),document.head.appendChild(t)}render(t,i){let a=this.charts[t];a.scaleInactiveLeft.style.width=`${100*a.params.offset[0]}%`,a.scaleInactiveRight.style.width=`${100*(1-a.params.offset[1])}%`,null==a.params.last_y&&(a.params.last_y=a.params.max_y),null==a.params.cur_y&&(a.params.new_axis_opacity=1,a.params.cur_y=a.params.max_y),a.params.last_y!=a.params.max_y&&(a.params.last_max_bb=a.params.cur_max_bb,a.params.new_axis_opacity=0,cancelAnimationFrame(a.params.anim),a.params.anim=this.animateValue(a.params.cur_y,a.params.max_y,(i,e,n)=>{a.params.cur_y=i,a.params.new_axis_opacity=e,a.params.anim=requestAnimationFrame(()=>{this.render(t)})},300),a.params.last_y=a.params.max_y),this.clearCanvas(t),this.drawAxis(t,a.params.offset,a.params.cur_y,1),Object.entries(this.data[t].types).forEach(i=>{"x"!=i[1]&&(this.drawLine(t,0,i[0],a.params.offset,a.params.cur_y,a.params.opacity[i[0]]),this.drawLine(t,1,i[0],null,null,a.params.opacity[i[0]]))})}easeInOut(t){return t*t}toggle(t,i){let a=!this.charts[t].params.visible[i],e=this.charts[t].params.opacity[i],n=0;return Object.values(this.charts[t].params.visible).forEach(t=>{t&&n++}),a||1!=n?(this.animateValue(e,a?1:0,a=>{this.charts[t].params.opacity[i]=parseFloat(a.toFixed(2)),requestAnimationFrame(()=>{this.render(t)})},300),this.charts[t].params.visible[i]=a,a?1:0):1}animateValue(t,i,a,e=300){let n=performance.now();requestAnimationFrame(function s(r){let o=r-n,h=o/e;h<0&&(h=0),h>1&&(h=1),h=this.easeInOut(h);let d=o>e;a(t+(i-t)*h,h,d),!d&&requestAnimationFrame(s.bind(this))}.bind(this))}animate(t){this.animationStart||(this.animationStart=performance.now());this.animationStart;requestAnimationFrame(this.animate.bind(this))}getBB(t,i){let a=this.data[t].columns,e={x:{},y:{}};a.forEach(t=>{let i=(t=[...t]).shift(),a=Math.min(...t),n=Math.max(...t);"x"==i&&(e.x.min=a,e.x.max=n)}),e.x.high=e.x.max-e.x.min,i&&(e.x.max=e.x.min+e.x.high*i[1],e.x.min=e.x.min+e.x.high*i[0],e.x.high=e.x.max-e.x.min);let n={};return a.forEach(t=>{"x"==(t=[...t]).shift()&&(n.max_length=t.length,t.forEach((t,i)=>{t>=e.x.min&&(n.min=void 0===n.min?i:Math.min(n.min,i)),t<=e.x.max&&(n.max=void 0===n.max?i:Math.max(n.max,i))}))}),n.min>n.max&&(n.max=n.min),n.min&&n.min--,n.max!=n.max_length-1&&n.max++,a.forEach(i=>{let a=(i=[...i]).shift();if("x"!=a){if(!this.charts[t].params.visible[a])return;i=[...i.splice(n.min,n.max-n.min+1)];let s=Math.min(...i),r=Math.max(...i);e.y.min=void 0===e.y.min?s:Math.min(e.y.min,s),e.y.max=void 0===e.y.max?r:Math.max(e.y.max,r)}}),e.y.min=0,e.y.high=e.y.max-e.y.min,e}clearCanvas(t){this.charts[t].canvasCtx.forEach((i,a)=>{let e=this.charts[t].canvas[a];i.clearRect(0,0,e.width,e.height)})}drawLine(t,i,a,e,n,s=1){let r=this.getBB(t,e),o=this.charts[t],h=this.data[t],d=(o.canvas[i],o.canvasCtx[i]);n=n||r.y.max,d.lineWidth=4,d.lineJoin="round",h.columns.forEach(t=>{let e=(t=[...t]).shift();if(a==e){let a=!1;d.beginPath(),d.strokeStyle=h.colors[e]+parseInt(255*s).toString(16).padStart(2,"0"),t.forEach((t,e)=>{let s=1-(t-r.y.min)/(n-r.y.min),l=this.padding[i].vertical+(o.canvas[i].height-2*this.padding[i].vertical-this.padding[i].bottom)*s,c=(h.columns[0][e+1]-r.x.min)/r.x.high,m=this.padding[i].horizontal+(o.canvas[i].width-2*this.padding[i].horizontal)*c;a?d.lineTo(m,l):(d.moveTo(m,l),a=!0)}),d.stroke()}})}drawAxis(t,i,a,e,n){let s=this.getBB(t),r=this.getBB(t,i),o=this.charts[t],h=(this.data[t],o.canvas[0]),d=o.canvasCtx[0];e=void 0!==e?parseInt(255*e).toString(16).padStart(2,"0"):"00",r.y.max=n||r.y.max,a=a||r.y.max,d.lineWidth=4,d.lineJoin="round",d.font="24px Roboto",d.fillStyle=("night"==this.mode?"#546778":"#96a2aa")+e,d.strokeStyle=("night"==this.mode?"#293544":"#f2f4f5")+e,d.beginPath(),d.textAlign="start",d.textBaseline="bottom";o.canvas[0].width,this.padding[0].vertical;let l=parseInt(r.y.high/5),c=Math.pow(10,l.toString().length-1);l=parseInt(l/c)*c;let m=this.nearestPow(r.y.high/5,l);this.charts[t].params.max_y=r.y.max;for(let t=r.y.min;t<=r.y.max;t+=m){let i=1-(t-r.y.min)/(a-r.y.min),e=this.padding[0].vertical+(h.height-2*this.padding[0].vertical-this.padding[0].bottom)*i;r.y.high;d.moveTo(this.padding[0].horizontal,e),d.lineTo(h.width-this.padding[0].horizontal,e),d.fillText(t,this.padding[0].horizontal,e)}d.textAlign="center",d.textBaseline="top";let p=o.canvas[0].width-2*this.padding[0].horizontal,x=p-80,g=parseInt(p/200),v=this.nearestPow(r.x.high/g);v=this.round(v,864e5);for(let t=parseInt(s.x.max-this.round(s.x.max-r.x.max,v)+v);t>=parseInt(r.x.min-v);t-=v){var u=(t-r.x.min)/r.x.high,f=(this.padding[0].horizontal,this.padding[0].horizontal+40+x*u);let i=new Date(t),a=i.toLocaleString("en-us",{month:"short"}),e=i.getDate();d.fillText(`${a} ${e}`,f,h.height-this.padding[0].vertical)}return d.stroke(),r.y.max}round(t,i){return Math.ceil(t/i)*i}nearestPow(t,i=2){return Math.pow(i,Math.round(Math.log(t)/Math.log(i)))}renderHtml(){this.charts=[],this.el.innerHTML=this.data.map((t,i)=>tpl(t,i,this.options.classPrefix)).join("");let t=this.options.classPrefix;this.qa(`.${t}`,this.el).forEach((i,a)=>{let e=this.qa("canvas",i),n={},s={};Object.keys(this.data[a].names).forEach(t=>{n[t]=!0,s[t]=1}),e.forEach(t=>{t.width=2*t.parentElement.offsetWidth,t.height=2*t.parentElement.offsetHeight}),this.charts.push({el:i,canvas:e,canvasCtx:[e[0].getContext("2d"),e[1].getContext("2d")],popup:this.q(`.${t}-popup`,i),names:this.qa(`.${t}-legend>div`,i),scale:this.q(`.${t}-scale`,i),scaleZone:this.q(`.${t}-scale-zone`,i),scaleLeft:this.q(`.${t}-scale-zone div:first-child`,i),scaleRight:this.q(`.${t}-scale-zone div:last-child`,i),scaleInactiveLeft:this.q(`.${t}-scale-inactive:first-of-type`,i),scaleInactiveRight:this.q(`.${t}-scale-inactive:last-of-type`,i),params:{offset:[.5,.9],visible:n,opacity:s,max_value:[200,200],axis:{}}}),this.render(a)}),this.initListeners()}initListeners(){let t,i,a,e=e=>{n=parseInt(e.target.closest(".chart").getAttribute("idx")),t=e.touches?e.touches[0].screenX:e.screenX,i=this.charts[n].params.offset,a=0,document.body.style.cursor="pointer",e.target==this.charts[n].scaleLeft&&(a=-1,document.body.style.cursor="w-resize"),e.target==this.charts[n].scaleRight&&(a=1,document.body.style.cursor="e-resize")},n=!1;this.on("resize orientationchange",window,t=>{this.charts.forEach((t,i)=>{t.canvas.forEach(t=>{t.width=2*t.parentElement.offsetWidth,t.height=2*t.parentElement.offsetHeight}),this.render(i)})}),this.on("touchmove mousemove",document,e=>{if(!1===n)return;let s=this.charts[n],r=(e.touches?e.touches[0].screenX:e.screenX)-t,o=1/s.scale.offsetWidth*r,h=i[1]-i[0],d=[...i],l=[d[1]-.03,d[0]+.03];(!a||a<0)&&(d[0]+=o),(!a||a>0)&&(d[1]+=o),d[0]<0&&(d[0]=0,a||(d[1]=h)),d[1]>1&&(d[1]=1,a||(d[0]=1-h)),a<0&&d[0]>l[0]&&(d[0]=l[0]),a>0&&d[1]<l[1]&&(d[1]=l[1]),s.params.offset=d,this.render(n)}).on("touchend mouseup",document,t=>{n=!1,document.body.style.cursor=""}),this.charts.forEach(t=>{t.names.forEach(t=>this.on("click",t,t=>{let i=t.srcElement.closest("[checked]"),a=parseInt(i.closest("[idx]").getAttribute("idx")),e=this.toggle(a,i.getAttribute("name"));i.setAttribute("checked",e)})),this.on("touchstart mousedown",t.scaleZone,e)})}on(t,i,a){return t.split(" ").forEach(t=>i.addEventListener(t,a,{passive:!0})),this}q(t,i=document){return i.querySelector(t)}qa(t,i=document){return i.querySelectorAll(t)}async load(t){let i=await fetch(t);return this.data=await i.json(),this.renderHtml(),this}setMode(t){return this.mode=t,this.el.setAttribute("mode",t),this.charts&&this.charts.forEach((t,i)=>this.render(i)),this}}const tpl=(t,i,a)=>`<div class="${a}" idx="${i}"><div class="${a}-title">Chart #${i}</div><div class="${a}-chart"><canvas></canvas></div><div class="${a}-scale"><canvas></canvas><div class="${a}-scale-inactive"></div><div class="${a}-scale-zone"><div></div><div></div></div><div class="${a}-scale-inactive"></div></div><div class="${a}-legend">${Object.entries(t.names).map((i,a)=>`<div checked="1" name="${i[0]}"><div><div style="border-color: ${t.colors[i[0]]}"></div><div></div></div>${i[1]}</div>`).join("")}</div></div>`,style=t=>`.${t} {margin: 0 auto;padding-bottom: 12px;background-color: #252f3e;}[mode=day] .${t} {background-color: #fff;}.${t} canvas {/*background: #ffffff22;*/position: absolute;width: 100%;height: 100%;}.${t}-title {padding-left: 16px;letter-spacing: 0.8px;font-weight: 500;color: #fff;}[mode=day] .${t}-title {color: #000;}.${t}-chart {position: relative;margin-bottom: 8px;height: 327px;}.${t}-chart:after {// content: '';position: absolute;display: block;top: 0;left: 0;right: 0;height: 20px;background: linear-gradient(to bottom, #252f3e 0%, #252f3e00 100%); }[mode=day] .${t}-chart:after {background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); }.${t}-scale {position: relative;height: 40px;margin: 0 12px 15px;box-sizing: border-box;display: flex;}.${t}-scale-inactive {background: #202a38bd;z-index: 1;width: 20%;}[mode=day] .${t}-scale-inactive {background: #eef0f1b5;}.${t}-scale-zone {position: relative;border-right: 5px solid #7faad252;    border-left: 5px solid #7faad252;    border-top: 1px solid #7faad252;    border-bottom: 1px solid #7faad252;flex: 1;display: flex;justify-content: space-between;cursor: pointer;}.${t}-scale-zone div {position: relative;display: block;width: 5px;margin-left: -5px;cursor: w-resize;}.${t}-scale-zone div:after {z-index: 2;content: '';display: block;position: absolute;left: -5px;top: 0;right: 0;bottom: 0;}.${t}-scale-zone div:last-child {margin-right: -5px;cursor: e-resize;}.${t}-scale-zone div:last-child:after {left: 0;right: -5px;}.${t}-legend {display: flex;flex-wrap: wrap;padding: 0 5px;}.${t}-legend>div {position: relative;border: 1px solid #344658;height: 33px;border-radius: 50px;display: flex;align-items: center;padding: 0 14px 0 38px;font-size: 13px;color: #e8ecee;margin: 0 7px 14px;cursor: pointer;}[mode=day] .${t}-legend>div {color: #43484b;border-color: #e6ecf0;}.${t}-legend>div>div {width: 22px;height: 22px;position: absolute;top: 6px;left: 6px;}.${t}-legend>div>div>div {position: absolute;width: 100%;height: 100%;transition: all .3s;}.${t}-legend>div>div>div:first-child {border: 11px solid;border-radius: 50%;box-sizing: border-box;}.${t}-legend>div[checked="0"]>div>div:first-child {border-width: 2px;}.${t}-legend>div>div>div:last-child {background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDQwNS4yNzIgNDA1LjI3MiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDA1LjI3MiA0MDUuMjcyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGc+PGc+Cgk8cGF0aCBkPSJNMzkzLjQwMSwxMjQuNDI1TDE3OS42MDMsMzM4LjIwOGMtMTUuODMyLDE1LjgzNS00MS41MTQsMTUuODM1LTU3LjM2MSwwTDExLjg3OCwyMjcuODM2ICAgYy0xNS44MzgtMTUuODM1LTE1LjgzOC00MS41MiwwLTU3LjM1OGMxNS44NDEtMTUuODQxLDQxLjUyMS0xNS44NDEsNTcuMzU1LTAuMDA2bDgxLjY5OCw4MS42OTlMMzM2LjAzNyw2Ny4wNjQgICBjMTUuODQxLTE1Ljg0MSw0MS41MjMtMTUuODI5LDU3LjM1OCwwQzQwOS4yMyw4Mi45MDIsNDA5LjIzLDEwOC41NzgsMzkzLjQwMSwxMjQuNDI1eiIgZGF0YS1vcmlnaW5hbD0iIzAwMDAwMCIgY2xhc3M9ImFjdGl2ZS1wYXRoIiBzdHlsZT0iZmlsbDojRkZGRkZGIiBkYXRhLW9sZF9jb2xvcj0iIzAwMDAwMCI+PC9wYXRoPgo8L2c+PC9nPiA8L3N2Zz4=) center no-repeat;background-size: 13px;}.${t}-legend>div[checked="0"]>div>div:last-child {transform: scale(0);}`;