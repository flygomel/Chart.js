export default class Chart{constructor(a,b){return this.el="string"==typeof a?this.q(a):a,this.options={...{classPrefix:"chart",mode:"night"},...b},this.padding=[{vertical:46,horizontal:24,bottom:20},{vertical:8,horizontal:0,bottom:0}],this.setMode(this.options.mode),this.addStyle(),this}addStyle(){let a=document.createElement("style");a.innerHTML=style(this.options.classPrefix),document.head.appendChild(a)}render(a){let b=this.charts[a];b.scaleInactiveLeft.style.width=`${100*b.params.offset[0]}%`,b.scaleInactiveRight.style.width=`${100*(1-b.params.offset[1])}%`,b.params.last_y==null&&(b.params.last_y=b.params.max_y),b.params.cur_y==null&&(b.params.new_axis_opacity=1,b.params.cur_y=b.params.max_y),b.params.last_y!=b.params.max_y&&(b.params.last_max_bb=b.params.cur_max_bb,b.params.new_axis_opacity=0,cancelAnimationFrame(b.params.anim),b.params.anim=this.animateValue(b.params.cur_y,b.params.max_y,(c,d)=>{b.params.cur_y=c,b.params.new_axis_opacity=d,b.params.anim=requestAnimationFrame(()=>{this.render(a)})},300),b.params.last_y=b.params.max_y),this.clearCanvas(a),this.drawAxis(a,b.params.offset,b.params.cur_y,1),Object.entries(this.data[a].types).forEach(c=>{"x"==c[1]||(this.drawLine(a,0,c[0],b.params.offset,b.params.cur_y,b.params.opacity[c[0]]),this.drawLine(a,1,c[0],null,null,b.params.opacity[c[0]]))})}easeInOut(a){return a*a}toggle(a,b){let c=!this.charts[a].params.visible[b],d=this.charts[a].params.opacity[b],e=0;return(Object.values(this.charts[a].params.visible).forEach(a=>{a&&e++}),!c&&1==e)?1:(this.animateValue(d,c?1:0,c=>{this.charts[a].params.opacity[b]=parseFloat(c.toFixed(2)),requestAnimationFrame(()=>{this.render(a)})},300),this.charts[a].params.visible[b]=c,c?1:0)}animateValue(a,b,c,d=300){let e=performance.now();requestAnimationFrame(function f(g){let h=g-e,i=h/d;0>i&&(i=0),1<i&&(i=1),i=this.easeInOut(i);let j=a+(b-a)*i,k=h>d;c(j,i,k),k||requestAnimationFrame(f.bind(this))}.bind(this))}animate(a){this.animationStart||(this.animationStart=performance.now());a-this.animationStart;requestAnimationFrame(this.animate.bind(this))}getBB(a,b){let c=this.data[a].columns,d={x:{},y:{}};c.forEach(a=>{a=[...a];let b=a.shift(),c=Math.min(...a),e=Math.max(...a);"x"==b&&(d.x.min=c,d.x.max=e)}),d.x.high=d.x.max-d.x.min,b&&(d.x.max=d.x.min+d.x.high*b[1],d.x.min+=d.x.high*b[0],d.x.high=d.x.max-d.x.min);let e={};return c.forEach(a=>{a=[...a];let b=a.shift();"x"==b&&(e.max_length=a.length,a.forEach((a,b)=>{a>=d.x.min&&(e.min=void 0===e.min?b:Math.min(e.min,b)),a<=d.x.max&&(e.max=void 0===e.max?b:Math.max(e.max,b))}))}),e.min>e.max&&(e.max=e.min),e.min&&e.min--,e.max!=e.max_length-1&&e.max++,c.forEach(b=>{b=[...b];let c=b.shift();if("x"!=c){if(!this.charts[a].params.visible[c])return;b=[...b.splice(e.min,e.max-e.min+1)];let f=Math.min(...b),g=Math.max(...b);d.y.min=void 0===d.y.min?f:Math.min(d.y.min,f),d.y.max=void 0===d.y.max?g:Math.max(d.y.max,g)}}),d.y.min=0,d.y.high=d.y.max-d.y.min,d}clearCanvas(a){this.charts[a].canvasCtx.forEach((b,c)=>{let d=this.charts[a].canvas[c];b.clearRect(0,0,d.width,d.height)})}drawLine(a,b,c,d,e,f=1){let g=this.getBB(a,d),h=this.charts[a],i=this.data[a],j=h.canvas[b],k=h.canvasCtx[b];e=e?e:g.y.max,k.lineWidth=4,k.lineJoin="round",i.columns.forEach(a=>{a=[...a];let d=a.shift();if(c==d){let c=!1;k.beginPath(),k.strokeStyle=i.colors[d]+parseInt(255*f).toString(16).padStart(2,"0"),a.forEach((a,d)=>{let f=1-(a-g.y.min)/(e-g.y.min),j=this.padding[b].vertical+(h.canvas[b].height-2*this.padding[b].vertical-this.padding[b].bottom)*f,l=(i.columns[0][d+1]-g.x.min)/g.x.high,m=this.padding[b].horizontal+(h.canvas[b].width-2*this.padding[b].horizontal)*l;c?k.lineTo(m,j):(k.moveTo(m,j),c=!0)}),k.stroke()}})}drawAxis(a,b,c,d,e){let f=this.getBB(a),g=this.getBB(a,b),h=this.charts[a],i=this.data[a],j=h.canvas[0],k=h.canvasCtx[0];d=void 0===d?"00":parseInt(255*d).toString(16).padStart(2,"0"),g.y.max=e?e:g.y.max,c=c?c:g.y.max,k.lineWidth=4,k.lineJoin="round",k.font="24px Roboto",k.fillStyle=("night"==this.mode?"#546778":"#96a2aa")+d,k.strokeStyle=("night"==this.mode?"#293544":"#f2f4f5")+d,k.beginPath(),k.textAlign="start",k.textBaseline="bottom";let l=h.canvas[0].width-2*this.padding[0].vertical,m=parseInt(g.y.high/5),n=Math.pow(10,m.toString().length-1);m=parseInt(m/n)*n;let o=this.nearestPow(g.y.high/5,m);this.charts[a].params.max_y=g.y.max;for(let f=g.y.min;f<=g.y.max;f+=o){let a=1-(f-g.y.min)/(c-g.y.min),b=this.padding[0].vertical+(j.height-2*this.padding[0].vertical-this.padding[0].bottom)*a,d=g.y.high*(1-a);k.moveTo(this.padding[0].horizontal,b),k.lineTo(j.width-this.padding[0].horizontal,b),k.fillText(f,this.padding[0].horizontal,b)}k.textAlign="center",k.textBaseline="top";let p=h.canvas[0].width-2*this.padding[0].horizontal,q=parseInt(p/200),r=this.nearestPow(g.x.high/q);r=this.round(r,86400000);for(let h=parseInt(f.x.max-this.round(f.x.max-g.x.max,r)+r);h>=parseInt(g.x.min-r);h-=r){var s=(h-g.x.min)/g.x.high,t=this.padding[0].horizontal+p*s,u=this.padding[0].horizontal+40+(p-80)*s;let a=new Date(h),b=a.toLocaleString("en-us",{month:"short"}),c=a.getDate();k.fillText(`${b} ${c}`,u,j.height-this.padding[0].vertical)}return k.stroke(),g.y.max}round(a,b){return Math.ceil(a/b)*b}nearestPow(a,b=2){return Math.pow(b,Math.round(Math.log(a)/Math.log(b)))}renderHtml(){this.charts=[],this.el.innerHTML=this.data.map((a,b)=>tpl(a,b,this.options.classPrefix)).join("");let a=this.options.classPrefix;this.qa(`.${a}`,this.el).forEach((b,c)=>{let d=this.qa("canvas",b),e={},f={};Object.keys(this.data[c].names).forEach(a=>{e[a]=!0,f[a]=1}),d.forEach(a=>{a.width=2*a.parentElement.offsetWidth,a.height=2*a.parentElement.offsetHeight}),this.charts.push({el:b,canvas:d,canvasCtx:[d[0].getContext("2d"),d[1].getContext("2d")],popup:this.q(`.${a}-popup`,b),names:this.qa(`.${a}-legend>div`,b),scale:this.q(`.${a}-scale`,b),scaleZone:this.q(`.${a}-scale-zone`,b),scaleLeft:this.q(`.${a}-scale-zone div:first-child`,b),scaleRight:this.q(`.${a}-scale-zone div:last-child`,b),scaleInactiveLeft:this.q(`.${a}-scale-inactive:first-of-type`,b),scaleInactiveRight:this.q(`.${a}-scale-inactive:last-of-type`,b),params:{offset:[.5,.9],visible:e,opacity:f,max_value:[200,200],axis:{}}}),this.render(c)}),this.initListeners()}initListeners(){let a,b,c,d=d=>{f=parseInt(d.target.closest(".chart").getAttribute("idx")),a=d.touches?d.touches[0].screenX:d.screenX,b=this.charts[f].params.offset,c=0,document.body.style.cursor="pointer",d.target==this.charts[f].scaleLeft&&(c=-1,document.body.style.cursor="w-resize"),d.target==this.charts[f].scaleRight&&(c=1,document.body.style.cursor="e-resize")},f=!1;this.on("touchmove mousemove",document,d=>{if(!1!==f){let e=this.charts[f],g=(d.touches?d.touches[0].screenX:d.screenX)-a,h=1/e.scale.offsetWidth*g,i=b[1]-b[0],j=[...b],k=[j[1]-.03,j[0]+.03];(!c||0>c)&&(j[0]+=h),(!c||0<c)&&(j[1]+=h),0>j[0]&&(j[0]=0,!c&&(j[1]=i)),1<j[1]&&(j[1]=1,!c&&(j[0]=1-i)),0>c&&j[0]>k[0]&&(j[0]=k[0]),0<c&&j[1]<k[1]&&(j[1]=k[1]),e.params.offset=j,this.render(f)}}).on("touchend mouseup",document,()=>{f=!1,document.body.style.cursor=""}),this.charts.forEach(a=>{a.names.forEach(a=>this.on("click",a,a=>{let b=a.srcElement.closest("[checked]"),c=parseInt(b.closest("[idx]").getAttribute("idx")),d=this.toggle(c,b.getAttribute("name"));b.setAttribute("checked",d)})),this.on("touchstart mousedown",a.scaleZone,d)})}on(a,b,c){return a.split(" ").forEach(a=>b.addEventListener(a,c,{passive:!0})),this}q(a,b=document){return b.querySelector(a)}qa(a,b=document){return b.querySelectorAll(a)}async load(a){let b=await fetch(a);return this.data=await b.json(),this.renderHtml(),this}setMode(a){return this.mode=a,this.el.setAttribute("mode",a),this.charts&&this.charts.forEach((a,b)=>this.render(b)),this}}const tpl=(a,b,c)=>`<div class="${c}" idx="${b}"><div class="${c}-title">Chart #${b}</div><div class="${c}-chart"><canvas></canvas></div><div class="${c}-scale"><canvas></canvas><div class="${c}-scale-inactive"></div><div class="${c}-scale-zone"><div></div><div></div></div><div class="${c}-scale-inactive"></div></div><div class="${c}-legend">${Object.entries(a.names).map(b=>`<div checked="1" name="${b[0]}"><div><div style="border-color: ${a.colors[b[0]]}"></div><div></div></div>${b[1]}</div>`).join("")}</div></div>`,style=a=>`.${a} {margin: 0 auto;padding-bottom: 12px;background-color: #252f3e;}[mode=day] .${a} {background-color: #fff;}.${a} canvas {/*background: #ffffff22;*/position: absolute;width: 100%;height: 100%;}.${a}-title {padding-left: 16px;letter-spacing: 0.8px;font-weight: 500;color: #fff;}[mode=day] .${a}-title {color: #000;}.${a}-chart {position: relative;margin-bottom: 8px;height: 327px;}.${a}-chart:after {// content: '';position: absolute;display: block;top: 0;left: 0;right: 0;height: 20px;background: linear-gradient(to bottom, #252f3e 0%, #252f3e00 100%); }[mode=day] .${a}-chart:after {background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); }.${a}-scale {position: relative;height: 40px;margin: 0 12px 15px;box-sizing: border-box;display: flex;}.${a}-scale-inactive {background: #202a38bd;z-index: 1;width: 20%;}[mode=day] .${a}-scale-inactive {background: #eef0f1b5;}.${a}-scale-zone {position: relative;border-right: 5px solid #7faad252;    border-left: 5px solid #7faad252;    border-top: 1px solid #7faad252;    border-bottom: 1px solid #7faad252;flex: 1;display: flex;justify-content: space-between;cursor: pointer;}.${a}-scale-zone div {position: relative;display: block;width: 5px;margin-left: -5px;cursor: w-resize;}.${a}-scale-zone div:after {z-index: 2;content: '';display: block;position: absolute;left: -5px;top: 0;right: 0;bottom: 0;}.${a}-scale-zone div:last-child {margin-right: -5px;cursor: e-resize;}.${a}-scale-zone div:last-child:after {left: 0;right: -5px;}.${a}-legend {display: flex;flex-wrap: wrap;padding: 0 5px;}.${a}-legend>div {position: relative;border: 1px solid #344658;height: 33px;border-radius: 50px;display: flex;align-items: center;padding: 0 14px 0 38px;font-size: 13px;color: #e8ecee;margin: 0 7px 14px;cursor: pointer;}[mode=day] .${a}-legend>div {color: #43484b;border-color: #e6ecf0;}.${a}-legend>div>div {width: 22px;height: 22px;position: absolute;top: 6px;left: 6px;}.${a}-legend>div>div>div {position: absolute;width: 100%;height: 100%;transition: all .3s;}.${a}-legend>div>div>div:first-child {border: 11px solid;border-radius: 50%;box-sizing: border-box;}.${a}-legend>div[checked="0"]>div>div:first-child {border-width: 2px;}.${a}-legend>div>div>div:last-child {background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDQwNS4yNzIgNDA1LjI3MiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDA1LjI3MiA0MDUuMjcyOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGc+PGc+Cgk8cGF0aCBkPSJNMzkzLjQwMSwxMjQuNDI1TDE3OS42MDMsMzM4LjIwOGMtMTUuODMyLDE1LjgzNS00MS41MTQsMTUuODM1LTU3LjM2MSwwTDExLjg3OCwyMjcuODM2ICAgYy0xNS44MzgtMTUuODM1LTE1LjgzOC00MS41MiwwLTU3LjM1OGMxNS44NDEtMTUuODQxLDQxLjUyMS0xNS44NDEsNTcuMzU1LTAuMDA2bDgxLjY5OCw4MS42OTlMMzM2LjAzNyw2Ny4wNjQgICBjMTUuODQxLTE1Ljg0MSw0MS41MjMtMTUuODI5LDU3LjM1OCwwQzQwOS4yMyw4Mi45MDIsNDA5LjIzLDEwOC41NzgsMzkzLjQwMSwxMjQuNDI1eiIgZGF0YS1vcmlnaW5hbD0iIzAwMDAwMCIgY2xhc3M9ImFjdGl2ZS1wYXRoIiBzdHlsZT0iZmlsbDojRkZGRkZGIiBkYXRhLW9sZF9jb2xvcj0iIzAwMDAwMCI+PC9wYXRoPgo8L2c+PC9nPiA8L3N2Zz4=) center no-repeat;background-size: 13px;}.${a}-legend>div[checked="0"]>div>div:last-child {transform: scale(0);}`;